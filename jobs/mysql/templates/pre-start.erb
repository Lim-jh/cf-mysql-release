#!/bin/bash

set -e

RUN_DIR=/var/vcap/sys/run
MARIADB_JOB_DIR=/var/vcap/jobs/mysql
PRESTART_MARKER_FILE=$RUN_DIR/prestart_marker
DATADIR=/var/vcap/store/mysql

LOG_DIR=/var/vcap/sys/log/mysql
export LOG_FILE=$LOG_DIR/pre-start.stdout.log

mkdir -p $RUN_DIR
chown -R vcap:vcap $RUN_DIR
touch $PRESTART_MARKER_FILE

# Start syslog forwarding
/var/vcap/packages/syslog_aggregator/setup_syslog_forwarder.sh $MARIADB_JOB_DIR/config

rm -f /etc/my.cnf

if [ -d ${DATADIR} ]
then
  export DISABLE_SST=1
fi

MARIADB_CTRL_PREFIX_CMD="su vcap -c " ${MARIADB_JOB_DIR}/bin/bootstrap
